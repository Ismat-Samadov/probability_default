{% extends "base.html" %}

{% block title %}Retail Customer Scoring - PD Model API{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xl-8 mx-auto">
        <!-- Header Card -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-header" style="background: var(--gradient-primary); color: var(--text-on-primary);">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-1 fw-bold">
                            <i class="fas fa-user me-2"></i>Retail Customer PD Scoring
                        </h4>
                        <small class="opacity-75">Enter customer details for real-time probability of default assessment</small>
                    </div>
                    <div class="col-auto d-none d-md-block">
                        <div class="d-flex gap-2">
                            <span class="badge" style="background-color: var(--surface-color); color: var(--text-primary);">
                                <i class="fas fa-chart-line me-1"></i>AUC: 0.844
                            </span>
                            <span class="badge" style="background-color: var(--surface-color); color: var(--text-primary);">
                                <i class="fas fa-clock me-1"></i>&lt;100ms
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div class="card-body p-0">
                <div class="progress" style="height: 4px; background-color: var(--background-secondary);">
                    <div class="progress-bar" id="formProgress" style="width: 20%; background: var(--gradient-primary);"></div>
                </div>
            </div>
        </div>

        <!-- Main Form Card -->
        <div class="card shadow border-0">
            <div class="card-body p-4" style="background: var(--surface-color); color: var(--text-primary);">
                <form action="/predict/retail" method="POST" id="retailForm" novalidate>
                    <!-- Step 1: Personal Information -->
                    <div class="form-step active" id="step1">
                        <div class="step-header mb-4">
                            <h5 class="step-title border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-id-card me-2"></i>Personal Information
                                <span class="badge" style="background: var(--gradient-primary); color: var(--text-on-primary); margin-left: 0.5rem;">Step 1 of 4</span>
                            </h5>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="age" class="form-label">
                                    <i class="fas fa-birthday-cake me-1" style="color: var(--text-muted);"></i>Age *
                                </label>
                                <input type="number" class="form-control form-control-lg" id="age" name="age" 
                                       min="18" max="100" value="35" required>
                                <div class="form-text">Customer age (18-100 years)</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="employment_status" class="form-label">
                                    <i class="fas fa-briefcase me-1" style="color: var(--text-muted);"></i>Employment Status *
                                </label>
                                <select class="form-select form-select-lg" id="employment_status" name="employment_status" required>
                                    <option value="Full-time" selected>Full-time Employment</option>
                                    <option value="Part-time">Part-time Employment</option>
                                    <option value="Self-employed">Self-employed</option>
                                    <option value="Unemployed">Unemployed</option>
                                    <option value="Retired">Retired</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="employment_tenure" class="form-label">
                                    <i class="fas fa-clock me-1" style="color: var(--text-muted);"></i>Employment Tenure (years)
                                </label>
                                <input type="number" class="form-control form-control-lg" id="employment_tenure" 
                                       name="employment_tenure" min="0" max="50" step="0.1" value="3.0">
                                <div class="form-text">Years with current employer</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="years_at_address" class="form-label">
                                    <i class="fas fa-home me-1" style="color: var(--text-muted);"></i>Years at Current Address
                                </label>
                                <input type="number" class="form-control form-control-lg" id="years_at_address" 
                                       name="years_at_address" min="0" max="50" step="0.1" value="2.0">
                                <div class="form-text">Residential stability indicator</div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                Next: Financial Information <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Financial Information -->
                    <div class="form-step" id="step2">
                        <div class="step-header mb-4">
                            <h5 class="step-title border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-dollar-sign me-2"></i>Financial Information
                                <span class="badge" style="background: var(--gradient-primary); color: var(--text-on-primary); margin-left: 0.5rem;">Step 2 of 4</span>
                            </h5>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="income" class="form-label">
                                    <i class="fas fa-money-bill-wave me-1" style="color: var(--text-muted);"></i>Annual Income ($) *
                                </label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="income" name="income" 
                                           min="1000" max="1000000" value="75000" step="1000" required>
                                </div>
                                <div class="form-text">Gross annual income in USD</div>
                                <div id="income-helper" class="mt-2"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="credit_score" class="form-label">
                                    <i class="fas fa-chart-line me-1" style="color: var(--text-muted);"></i>Credit Score *
                                </label>
                                <input type="number" class="form-control form-control-lg" id="credit_score" name="credit_score" 
                                       min="300" max="850" value="720" required>
                                <div class="form-text">FICO score (300-850)</div>
                                <div id="credit-score-helper" class="mt-2"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="debt_to_income" class="form-label">
                                    <i class="fas fa-calculator me-1" style="color: var(--text-muted);"></i>Debt-to-Income Ratio *
                                </label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control" id="debt_to_income" name="debt_to_income" 
                                           min="0" max="5" step="0.01" value="0.30" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Total debt / annual income (e.g., 0.30 = 30%)</div>
                                <div id="debt-helper" class="mt-2"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="utilization_rate" class="form-label">
                                    <i class="fas fa-credit-card me-1" style="color: var(--text-muted);"></i>Credit Utilization Rate *
                                </label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control" id="utilization_rate" name="utilization_rate" 
                                           min="0" max="1" step="0.01" value="0.25" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Used credit / total credit limit (e.g., 0.25 = 25%)</div>
                                <div id="utilization-helper" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                Next: Credit Information <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Credit Information -->
                    <div class="form-step" id="step3">
                        <div class="step-header mb-4">
                            <h5 class="step-title border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-credit-card me-2"></i>Credit Information
                                <span class="badge" style="background: var(--gradient-primary); color: var(--text-on-primary); margin-left: 0.5rem;">Step 3 of 4</span>
                            </h5>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="num_accounts" class="form-label">
                                    <i class="fas fa-list me-1" style="color: var(--text-muted);"></i>Number of Credit Accounts
                                </label>
                                <input type="number" class="form-control form-control-lg" id="num_accounts" 
                                       name="num_accounts" min="0" max="30" value="5">
                                <div class="form-text">Total credit accounts (cards, loans, etc.)</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="monthly_transactions" class="form-label">
                                    <i class="fas fa-exchange-alt me-1" style="color: var(--text-muted);"></i>Monthly Transactions
                                </label>
                                <input type="number" class="form-control form-control-lg" id="monthly_transactions" 
                                       name="monthly_transactions" min="1" max="200" value="45">
                                <div class="form-text">Average monthly transaction count</div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep()">
                                Next: Review & Submit <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Review & Submit -->
                    <div class="form-step" id="step4">
                        <div class="step-header mb-4">
                            <h5 class="step-title border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-check-circle me-2"></i>Review & Submit
                                <span class="badge" style="background: var(--gradient-primary); color: var(--text-on-primary); margin-left: 0.5rem;">Step 4 of 4</span>
                            </h5>
                        </div>
                        
                        <div class="alert border-0" style="background-color: rgba(8, 145, 178, 0.1); color: var(--info-dark); border-left: 4px solid var(--info-color);" role="alert">
                            <div class="d-flex">
                                <i class="fas fa-info-circle me-3 mt-1"></i>
                                <div>
                                    <h6 class="alert-heading">Ready to Calculate PD Score</h6>
                                    <p class="mb-0">Please review the information below before submitting. You can go back to make changes if needed.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Review Summary -->
                        <div class="card border-0 mb-4" style="background: var(--background-secondary);">
                            <div class="card-body">
                                <h6 class="card-title" style="color: var(--text-primary);">
                                    <i class="fas fa-user me-2"></i>Customer Summary
                                </h6>
                                <div class="row g-3" id="reviewSummary">
                                    <!-- Summary will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Risk Assessment Preview -->
                        <div class="card border-0 mb-4" style="background-color: rgba(217, 119, 6, 0.1); border-left: 4px solid var(--warning-color);">
                            <div class="card-body">
                                <h6 class="card-title" style="color: var(--warning-dark);">
                                    <i class="fas fa-shield-alt me-2"></i>Risk Assessment Notes
                                </h6>
                                <div id="riskPreview">
                                    <p class="mb-0 small" style="color: var(--text-secondary);">Based on the provided information, this assessment will be conducted using our Basel III compliant model with IFRS 9 staging.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-warning btn-lg" onclick="resetForm()">
                                    <i class="fas fa-undo me-2"></i>Reset Form
                                </button>
                                <button type="submit" class="btn btn-success btn-lg px-4" id="submitBtn">
                                    <i class="fas fa-calculator me-2"></i>Calculate PD Score
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help & Information Card -->
        <div class="card mt-4 border-info" style="background-color: rgba(8, 145, 178, 0.1);">
            <div class="card-body">
                <h6 class="card-title" style="color: var(--info-dark);">
                    <i class="fas fa-lightbulb me-2"></i>About Retail PD Scoring
                </h6>
                <div class="row g-4">
                    <div class="col-md-8">
                        <p class="card-text small mb-3" style="color: var(--text-secondary);">
                            Our retail PD model uses advanced machine learning to assess individual customer default risk. 
                            The model analyzes 37+ risk factors including credit history, financial ratios, behavioral patterns, 
                            and macroeconomic conditions.
                        </p>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small style="color: var(--text-secondary);"><strong>PD Score:</strong> 12-month default probability</small>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small style="color: var(--text-secondary);"><strong>Risk Grade:</strong> AAA to C rating</small>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small style="color: var(--text-secondary);"><strong>IFRS 9 Stage:</strong> Regulatory staging</small>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <small style="color: var(--text-secondary);"><strong>Basel III:</strong> Minimum floor compliance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="rounded p-3 text-center" style="background: var(--surface-color);">
                            <div class="fw-bold fs-4" style="color: var(--primary-color);">0.844</div>
                            <small style="color: var(--text-muted);">Model AUC Score</small>
                            <hr style="border-color: var(--border-color);" class="my-2">
                            <div class="fw-bold fs-5" style="color: var(--success-color);">1.61%</div>
                            <small style="color: var(--text-muted);">Portfolio Default Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row g-3 mt-3">
            <div class="col-md-6">
                <div class="card border-0 h-100" style="background: var(--background-secondary);">
                    <div class="card-body text-center">
                        <i class="fas fa-upload fa-2x mb-2" style="color: var(--primary-color);"></i>
                        <h6 style="color: var(--text-primary);">Batch Processing</h6>
                        <p class="small mb-3" style="color: var(--text-muted);">Process multiple customers at once</p>
                        <a href="/batch" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Go to Batch
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 h-100" style="background: var(--background-secondary);">
                    <div class="card-body text-center">
                        <i class="fas fa-code fa-2x mb-2" style="color: var(--info-color);"></i>
                        <h6 style="color: var(--text-primary);">API Integration</h6>
                        <p class="small mb-3" style="color: var(--text-muted);">Integrate with your systems</p>
                        <a href="/api/docs" target="_blank" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>View API Docs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced theme-aware styling for retail form */
.step-title {
    border-bottom: 1px solid var(--border-color) !important;
    position: relative;
}

.step-title::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 50px;
    height: 2px;
    background: var(--primary-color);
    border-radius: 1px;
}

.form-step {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.form-step.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.progress-bar {
    transition: width 0.5s ease-in-out;
}

.form-control-lg, .form-select-lg {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
}

.step-header {
    position: relative;
}

.input-group-text {
    background-color: var(--background-secondary) !important;
    border-color: var(--border-color) !important;
    color: var(--text-primary) !important;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.form-label {
    color: var(--text-primary) !important;
    font-weight: 600;
}

.form-text {
    color: var(--text-muted) !important;
}

/* Helper styling */
.income-helper,
.credit-score-helper,
.debt-helper,
.utilization-helper {
    font-size: 0.875rem;
    transition: all var(--transition-normal);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .col-xl-8 {
        padding: 0 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn-lg {
        padding: 0.75rem 1rem;
        font-size: 1rem;
    }
    
    .step-title {
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }
    
    .badge {
        display: block;
        margin-top: 0.25rem;
        margin-left: 0 !important;
    }
    
    .input-group {
        flex-wrap: nowrap;
    }
    
    .input-group-text {
        min-width: auto;
        padding: 0.375rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-lg {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .d-flex.justify-content-between .btn:first-child {
        order: 2;
    }
    
    .d-flex.justify-content-between .d-flex {
        order: 1;
    }
}

/* Enhanced form interactivity */
.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color) !important;
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25) !important;
}

/* Smooth transitions for all elements */
.card,
.form-control,
.form-select,
.btn,
.input-group-text,
.alert {
    transition: all var(--transition-normal);
}

/* Review summary styling */
#reviewSummary .col-md-6,
#reviewSummary .col-lg-4 {
    margin-bottom: 0.5rem;
}

#reviewSummary .d-flex {
    color: var(--text-primary);
}

#reviewSummary strong {
    color: var(--text-muted);
}

/* Risk preview styling */
#riskPreview {
    color: var(--text-secondary);
}

#riskPreview .d-flex {
    align-items: center;
}

#riskPreview strong {
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 4;

document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupValidation();
    setupHelpers();
    updateProgress();
});

function initializeForm() {
    // Show only the first step
    showStep(1);
    
    // Add event listeners for real-time updates
    document.getElementById('retailForm').addEventListener('input', function(e) {
        validateStep(currentStep);
        updateProgress();
        updateReviewSummary();
    });
    
    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            if (currentStep < totalSteps) {
                nextStep();
            } else {
                document.getElementById('submitBtn').click();
            }
        }
        
        if (e.key === 'Escape') {
            if (currentStep > 1) {
                prevStep();
            }
        }
    });
}

function setupValidation() {
    const form = document.getElementById('retailForm');
    const inputs = form.querySelectorAll('input[required], select[required]');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateInput(this);
        });
        
        input.addEventListener('input', function() {
            clearValidation(this);
        });
    });
}

function setupHelpers() {
    // Income helper
    document.getElementById('income').addEventListener('input', function() {
        const income = parseFloat(this.value) || 0;
        const helper = document.getElementById('income-helper');
        
        if (income > 0) {
            let message = '';
            let className = 'small text-info';
            
            if (income < 30000) {
                message = '<i class="fas fa-info-circle me-1"></i>Below median household income';
                className = 'small text-warning';
            } else if (income > 100000) {
                message = '<i class="fas fa-star me-1"></i>High income bracket';
                className = 'small text-success';
            } else {
                message = '<i class="fas fa-check me-1"></i>Median income range';
                className = 'small text-info';
            }
            
            helper.innerHTML = `<div class="${className}">${message}</div>`;
        } else {
            helper.innerHTML = '';
        }
    });
    
    // Credit score helper
    document.getElementById('credit_score').addEventListener('input', function() {
        const score = parseInt(this.value) || 0;
        const helper = document.getElementById('credit-score-helper');
        
        if (score >= 300) {
            let message = '';
            let className = 'small';
            
            if (score >= 750) {
                message = '<i class="fas fa-star me-1 text-success"></i>Excellent credit';
                className += ' text-success';
            } else if (score >= 700) {
                message = '<i class="fas fa-thumbs-up me-1 text-primary"></i>Good credit';
                className += ' text-primary';
            } else if (score >= 650) {
                message = '<i class="fas fa-info-circle me-1 text-warning"></i>Fair credit';
                className += ' text-warning';
            } else {
                message = '<i class="fas fa-exclamation-triangle me-1 text-danger"></i>Poor credit';
                className += ' text-danger';
            }
            
            helper.innerHTML = `<div class="${className}">${message}</div>`;
        } else {
            helper.innerHTML = '';
        }
    });
    
    // DTI helper
    document.getElementById('debt_to_income').addEventListener('input', function() {
        updateDTIHelper();
    });
    
    document.getElementById('income').addEventListener('input', function() {
        updateDTIHelper();
    });
    
    // Utilization helper
    document.getElementById('utilization_rate').addEventListener('input', function() {
        const utilization = parseFloat(this.value) || 0;
        const percentage = (utilization * 100).toFixed(1);
        const helper = document.getElementById('utilization-helper');
        
        if (utilization > 0) {
            let message = '';
            let className = 'small';
            
            if (utilization <= 0.1) {
                message = '<i class="fas fa-star me-1 text-success"></i>Excellent utilization';
                className += ' text-success';
            } else if (utilization <= 0.3) {
                message = '<i class="fas fa-check me-1 text-primary"></i>Good utilization';
                className += ' text-primary';
            } else if (utilization <= 0.7) {
                message = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i>High utilization';
                className += ' text-warning';
            } else {
                message = '<i class="fas fa-times-circle me-1 text-danger"></i>Very high utilization';
                className += ' text-danger';
            }
            
            helper.innerHTML = `<div class="${className}">${percentage}% - ${message}</div>`;
        } else {
            helper.innerHTML = '';
        }
    });
}

function updateDTIHelper() {
    const income = parseFloat(document.getElementById('income').value) || 0;
    const dti = parseFloat(document.getElementById('debt_to_income').value) || 0;
    const helper = document.getElementById('debt-helper');
    
    if (income > 0 && dti > 0) {
        const totalDebt = income * dti;
        const monthlyDebt = totalDebt / 12;
        
        let message = `<i class="fas fa-calculator me-1"></i>Total debt: $${totalDebt.toLocaleString()} ($${monthlyDebt.toLocaleString()}/month)`;
        let className = 'small text-info';
        
        if (dti > 0.4) {
            message += ' - High debt burden';
            className = 'small text-danger';
        } else if (dti > 0.3) {
            message += ' - Moderate debt burden';
            className = 'small text-warning';
        } else {
            message += ' - Manageable debt burden';
            className = 'small text-success';
        }
        
        helper.innerHTML = `<div class="${className}">${message}</div>`;
    } else {
        helper.innerHTML = '';
    }
}

function nextStep() {
    if (currentStep < totalSteps) {
        if (validateStep(currentStep)) {
            hideStep(currentStep);
            currentStep++;
            showStep(currentStep);
            updateProgress();
            updateReviewSummary();
            
            // Scroll to top smoothly
            document.querySelector('.card-header').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        hideStep(currentStep);
        currentStep--;
        showStep(currentStep);
        updateProgress();
        
        // Scroll to top smoothly
        document.querySelector('.card-header').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

function showStep(step) {
    const stepElement = document.getElementById(`step${step}`);
    stepElement.classList.add('active');
    stepElement.style.display = 'block';
    
    // Focus on first input in the step
    const firstInput = stepElement.querySelector('input, select');
    if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
    }
}

function hideStep(step) {
    const stepElement = document.getElementById(`step${step}`);
    stepElement.classList.remove('active');
    stepElement.style.display = 'none';
}

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    const progressBar = document.getElementById('formProgress');
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
}

function validateStep(step) {
    const stepElement = document.getElementById(`step${step}`);
    const requiredInputs = stepElement.querySelectorAll('input[required], select[required]');
    let isValid = true;
    
    requiredInputs.forEach(input => {
        if (!validateInput(input)) {
            isValid = false;
        }
    });
    
    return isValid;
}

function validateInput(input) {
    const value = input.value.trim();
    let isValid = true;
    let message = '';
    
    // Clear previous validation
    clearValidation(input);
    
    // Required validation
    if (input.hasAttribute('required') && !value) {
        isValid = false;
        message = 'This field is required';
    }
    
    // Type-specific validation
    if (value && input.type === 'number') {
        const numValue = parseFloat(value);
        const min = parseFloat(input.min);
        const max = parseFloat(input.max);
        
        if (isNaN(numValue)) {
            isValid = false;
            message = 'Please enter a valid number';
        } else if (!isNaN(min) && numValue < min) {
            isValid = false;
            message = `Value must be at least ${min}`;
        } else if (!isNaN(max) && numValue > max) {
            isValid = false;
            message = `Value must be at most ${max}`;
        }
    }
    
    // Apply validation styles
    if (value) { // Only validate non-empty fields
        if (isValid) {
            input.classList.add('is-valid');
            input.classList.remove('is-invalid');
        } else {
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
            showValidationMessage(input, message);
        }
    }
    
    return isValid;
}

function clearValidation(input) {
    input.classList.remove('is-valid', 'is-invalid');
    const feedback = input.parentElement.querySelector('.invalid-feedback');
    if (feedback) feedback.remove();
}

function showValidationMessage(input, message) {
    const feedback = document.createElement('div');
    feedback.className = 'invalid-feedback';
    feedback.textContent = message;
    input.parentElement.appendChild(feedback);
}

function updateReviewSummary() {
    if (currentStep === 4) {
        const formData = new FormData(document.getElementById('retailForm'));
        const summary = document.getElementById('reviewSummary');
        
        const data = {
            'Age': formData.get('age') + ' years',
            'Employment': formData.get('employment_status'),
            'Annual Income': '$' + Number(formData.get('income')).toLocaleString(),
            'Credit Score': formData.get('credit_score'),
            'Debt-to-Income': (formData.get('debt_to_income') * 100).toFixed(1) + '%',
            'Utilization Rate': (formData.get('utilization_rate') * 100).toFixed(1) + '%'
        };
        
        let html = '';
        Object.entries(data).forEach(([key, value]) => {
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="d-flex justify-content-between">
                        <strong style="color: var(--text-muted);">${key}:</strong>
                        <span style="color: var(--text-primary);">${value}</span>
                    </div>
                </div>
            `;
        });
        
        summary.innerHTML = html;
        
        // Update risk preview
        updateRiskPreview(formData);
    }
}

function updateRiskPreview(formData) {
    const riskPreview = document.getElementById('riskPreview');
    const creditScore = parseInt(formData.get('credit_score'));
    const dti = parseFloat(formData.get('debt_to_income'));
    const utilization = parseFloat(formData.get('utilization_rate'));
    
    let riskLevel = 'Medium';
    let riskColor = 'warning';
    let riskIcon = 'exclamation-triangle';
    
    // Simple risk assessment
    if (creditScore >= 750 && dti <= 0.3 && utilization <= 0.3) {
        riskLevel = 'Low';
        riskColor = 'success';
        riskIcon = 'check-circle';
    } else if (creditScore < 650 || dti > 0.5 || utilization > 0.7) {
        riskLevel = 'High';
        riskColor = 'danger';
        riskIcon = 'exclamation-triangle';
    }
    
    riskPreview.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${riskIcon} text-${riskColor} me-2"></i>
            <div>
                <strong style="color: var(--text-primary);">Preliminary Risk Assessment: ${riskLevel}</strong>
                <p class="mb-0 small" style="color: var(--text-secondary);">This is a preliminary assessment. Final PD score will be calculated using our comprehensive model with 37+ risk factors.</p>
            </div>
        </div>
    `;
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
        document.getElementById('retailForm').reset();
        
        // Reset to defaults
        document.getElementById('age').value = '35';
        document.getElementById('employment_status').value = 'Full-time';
        document.getElementById('income').value = '75000';
        document.getElementById('credit_score').value = '720';
        document.getElementById('debt_to_income').value = '0.30';
        document.getElementById('utilization_rate').value = '0.25';
        document.getElementById('employment_tenure').value = '3.0';
        document.getElementById('years_at_address').value = '2.0';
        document.getElementById('num_accounts').value = '5';
        document.getElementById('monthly_transactions').value = '45';
        
        // Clear validation states
        document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
        });
        
        document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
        
        // Clear helpers
        document.querySelectorAll('[id$="-helper"]').forEach(el => el.innerHTML = '');
        
        // Reset to first step
        hideStep(currentStep);
        currentStep = 1;
        showStep(currentStep);
        updateProgress();
    }
}

// Form submission with loading state
document.getElementById('retailForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating PD Score...';
    submitBtn.disabled = true;
    
    // Update progress to 100%
    document.getElementById('formProgress').style.width = '100%';
});

// Theme change handler
window.addEventListener('themeChanged', function(e) {
    // Update any theme-specific dynamic content
    const helpers = document.querySelectorAll('[id$="-helper"]');
    helpers.forEach(helper => {
        // Refresh helper styling for new theme
        const currentHTML = helper.innerHTML;
        if (currentHTML) {
            helper.innerHTML = currentHTML; // Trigger CSS update
        }
    });
    
    // Update review summary colors
    updateReviewSummary();
});
</script>
{% endblock %}
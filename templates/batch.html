{% extends "base.html" %}

{% block title %}Batch Processing - PD Model API{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xl-10 mx-auto">
        <!-- Header Card -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-header bg-info text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-1 fw-bold">
                            <i class="fas fa-upload me-2"></i>Batch PD Scoring
                        </h4>
                        <small class="opacity-75">Upload CSV files for portfolio-level risk assessment</small>
                    </div>
                    <div class="col-auto d-none d-md-block">
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-clock me-1"></i>Real-time Progress
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-chart-bar me-1"></i>Instant Results
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-shield-alt me-1"></i>Basel III Compliant
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Templates Card -->
        <div class="card shadow border-0 mb-4">
            <div class="card-header bg-success-subtle">
                <h5 class="mb-0 text-success-emphasis">
                    <i class="fas fa-download me-2"></i>Download CSV Templates
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Start with our pre-formatted templates to ensure your data is structured correctly:</p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-user fa-3x text-primary mb-3"></i>
                                <h6 class="card-title">Retail Banking</h6>
                                <p class="small text-muted mb-3">Individual customers and consumers</p>
                                <a href="/api/templates/retail.csv" class="btn btn-primary btn-sm w-100 mb-2">
                                    <i class="fas fa-download me-1"></i>Download Template
                                </a>
                                <div class="mt-2">
                                    <span class="badge bg-primary-subtle text-primary-emphasis">5 required columns</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-success h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-building fa-3x text-success mb-3"></i>
                                <h6 class="card-title">SME Banking</h6>
                                <p class="small text-muted mb-3">Small & medium enterprises</p>
                                <a href="/api/templates/sme.csv" class="btn btn-success btn-sm w-100 mb-2">
                                    <i class="fas fa-download me-1"></i>Download Template
                                </a>
                                <div class="mt-2">
                                    <span class="badge bg-success-subtle text-success-emphasis">5 required columns</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-city fa-3x text-warning mb-3"></i>
                                <h6 class="card-title">Corporate Banking</h6>
                                <p class="small text-muted mb-3">Large corporations and enterprises</p>
                                <a href="/api/templates/corporate.csv" class="btn btn-warning btn-sm w-100 mb-2">
                                    <i class="fas fa-download me-1"></i>Download Template
                                </a>
                                <div class="mt-2">
                                    <span class="badge bg-warning-subtle text-warning-emphasis">5 required columns</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Upload Card -->
        <div class="card shadow border-0">
            <div class="card-body p-4">
                <form action="/api/predict/batch" method="POST" enctype="multipart/form-data" id="batchForm">
                    <div class="row g-4">
                        <!-- Segment Selection -->
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-layer-group me-2"></i>Step 1: Select Model Segment
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-lg-4">
                                    <div class="segment-option" data-segment="retail">
                                        <input type="radio" class="btn-check" name="segment" id="segment-retail" value="retail" required>
                                        <label class="btn btn-outline-primary btn-lg w-100 h-100" for="segment-retail">
                                            <div class="text-center p-3">
                                                <i class="fas fa-user fa-2x mb-2"></i>
                                                <h6 class="mb-1">Retail Banking</h6>
                                                <small class="text-muted">Individual consumers</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-primary-subtle text-primary-emphasis">Most Flexible</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="segment-option" data-segment="sme">
                                        <input type="radio" class="btn-check" name="segment" id="segment-sme" value="sme" required>
                                        <label class="btn btn-outline-success btn-lg w-100 h-100" for="segment-sme">
                                            <div class="text-center p-3">
                                                <i class="fas fa-building fa-2x mb-2"></i>
                                                <h6 class="mb-1">SME Banking</h6>
                                                <small class="text-muted">Small & medium enterprises</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-success-subtle text-success-emphasis">Auto-Fill Missing</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="segment-option" data-segment="corporate">
                                        <input type="radio" class="btn-check" name="segment" id="segment-corporate" value="corporate" required>
                                        <label class="btn btn-outline-warning btn-lg w-100 h-100" for="segment-corporate">
                                            <div class="text-center p-3">
                                                <i class="fas fa-city fa-2x mb-2"></i>
                                                <h6 class="mb-1">Corporate Banking</h6>
                                                <small class="text-muted">Large corporations</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-warning-subtle text-warning-emphasis">Smart Defaults</span>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Upload Section -->
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-file-csv me-2"></i>Step 2: Upload Your Data File
                            </h6>
                            
                            <div class="upload-container">
                                <div class="upload-area border-2 border-dashed border-info rounded p-5 text-center" id="upload-area">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt fa-4x text-info mb-3"></i>
                                        <h5 class="mb-3">Drop your CSV file here or click to browse</h5>
                                        <p class="text-muted mb-3">
                                            <strong>File Requirements:</strong><br>
                                            Maximum size: <span class="badge bg-info-subtle text-info-emphasis">10MB</span> | 
                                            Format: <span class="badge bg-info-subtle text-info-emphasis">CSV only</span> |
                                            Max rows: <span class="badge bg-info-subtle text-info-emphasis">10,000</span>
                                        </p>
                                        <input type="file" class="form-control d-none" id="batch-file" name="file" accept=".csv" required>
                                        <button type="button" class="btn btn-info btn-lg" onclick="document.getElementById('batch-file').click()">
                                            <i class="fas fa-folder-open me-2"></i>Choose File
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Preview Area -->
                                <div class="file-preview-container mt-3" id="file-preview-container" style="display: none;">
                                    <!-- File Info -->
                                    <div class="alert alert-info border-0" id="file-info">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <h6 class="alert-heading mb-1">
                                                    <i class="fas fa-file-csv me-2"></i>Selected File
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <strong>Name:</strong> <span id="file-name"></span>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Size:</strong> <span id="file-size"></span>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Rows:</strong> <span id="file-rows">Calculating...</span>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <strong>Status:</strong> <span id="file-status" class="badge bg-secondary">Checking...</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFile()">
                                                    <i class="fas fa-times me-1"></i>Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- File Content Preview -->
                                    <div class="card border-0 bg-light" id="file-preview">
                                        <div class="card-header bg-transparent border-0">
                                            <h6 class="mb-0">
                                                <i class="fas fa-eye me-2"></i>File Preview (First 5 rows)
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover" id="preview-table">
                                                    <thead class="table-dark">
                                                        <!-- Headers will be populated by JavaScript -->
                                                    </thead>
                                                    <tbody>
                                                        <!-- Rows will be populated by JavaScript -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Validation Results -->
                                    <div class="validation-results mt-3" id="validation-results">
                                        <!-- Validation info will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Options -->
                        <div class="col-12" id="processing-options" style="display: none;">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-cogs me-2"></i>Step 3: Processing Options
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-tachometer-alt me-2 text-primary"></i>Processing Mode
                                            </h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="processing_mode" id="mode-standard" value="standard" checked>
                                                <label class="form-check-label" for="mode-standard">
                                                    <strong>Standard Processing</strong><br>
                                                    <small class="text-muted">Full feature engineering with all validations</small>
                                                </label>
                                            </div>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="radio" name="processing_mode" id="mode-fast" value="fast">
                                                <label class="form-check-label" for="mode-fast">
                                                    <strong>Fast Processing</strong><br>
                                                    <small class="text-muted">Optimized for speed with smart defaults</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-download me-2 text-success"></i>Output Options
                                            </h6>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="include-details" checked>
                                                <label class="form-check-label" for="include-details">
                                                    Include prediction details
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="include-summary" checked>
                                                <label class="form-check-label" for="include-summary">
                                                    Include summary statistics
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="include-risk-grades" checked>
                                                <label class="form-check-label" for="include-risk-grades">
                                                    Include risk grades and IFRS 9 staging
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div class="col-12" id="progress-section" style="display: none;">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-chart-line me-2"></i>Processing Progress
                            </h6>
                            
                            <div class="card border-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-semibold">Processing Status</span>
                                        <span id="progress-percentage" class="badge bg-primary">0%</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 12px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                             id="batch-progress" style="width: 0%"></div>
                                    </div>
                                    <div class="row g-3 text-center">
                                        <div class="col-md-3">
                                            <div class="fw-bold text-primary fs-4" id="total-records">0</div>
                                            <small class="text-muted">Total Records</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="fw-bold text-success fs-4" id="processed-records">0</div>
                                            <small class="text-muted">Successfully Processed</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="fw-bold text-danger fs-4" id="failed-records">0</div>
                                            <small class="text-muted">Failed</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="fw-bold text-info fs-4" id="processing-time">00:00</div>
                                            <small class="text-muted">Time Elapsed</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div id="progress-text" class="text-center">
                                            <small class="text-muted">Ready to start processing...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Section -->
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo me-2"></i>Reset Form
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-info btn-lg px-5" id="submitBtn" disabled>
                                        <i class="fas fa-play me-2"></i>Start Batch Processing
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Column Requirements Reference -->
        <div class="row g-4 mt-3">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info-subtle border-info">
                        <h6 class="mb-0 text-info-emphasis">
                            <i class="fas fa-table me-2"></i>Column Requirements Reference
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="columnsAccordion">
                            <!-- Retail Columns -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#retailColumns">
                                        <i class="fas fa-user me-2 text-primary"></i>Retail Segment - Required vs Optional Columns
                                    </button>
                                </h2>
                                <div id="retailColumns" class="accordion-collapse collapse" data-bs-parent="#columnsAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Required Columns (Must Include):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-danger border-3"><code>age</code> - Customer age (18-100 years)</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>income</code> - Annual income in USD</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>credit_score</code> - Credit score (300-850)</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>debt_to_income</code> - Debt-to-income ratio (0.0-5.0)</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>utilization_rate</code> - Credit utilization (0.0-1.0)</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-success"><i class="fas fa-check-circle me-1"></i>Optional Columns (Auto-filled with smart defaults):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-success border-3"><code>employment_status</code> - Employment type</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>employment_tenure</code> - Years with employer</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>years_at_address</code> - Years at address</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>num_accounts</code> - Number of accounts</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>monthly_transactions</code> - Monthly transactions</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SME Columns -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#smeColumns">
                                        <i class="fas fa-building me-2 text-success"></i>SME Segment - Required vs Optional Columns
                                    </button>
                                </h2>
                                <div id="smeColumns" class="accordion-collapse collapse" data-bs-parent="#columnsAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Required Columns (Must Include):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-danger border-3"><code>industry</code> - Business industry sector</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>annual_revenue</code> - Annual revenue in USD</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>num_employees</code> - Number of employees</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>current_ratio</code> - Current assets / liabilities</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>debt_to_equity</code> - Debt-to-equity ratio</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-success"><i class="fas fa-check-circle me-1"></i>Optional Columns (Auto-filled if missing):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-success border-3"><code>profit_margin</code> - Net profit margin</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>years_in_business</code> - Years established</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>payment_delays_12m</code> - Payment delays count</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>days_past_due</code> - Current past due days</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>credit_utilization</code> - Credit utilization rate</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="alert alert-info mt-3 mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Note:</strong> The system will automatically calculate missing financial metrics and apply industry-standard defaults for optional fields.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Corporate Columns -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#corporateColumns">
                                        <i class="fas fa-city me-2 text-warning"></i>Corporate Segment - Required vs Optional Columns
                                    </button>
                                </h2>
                                <div id="corporateColumns" class="accordion-collapse collapse" data-bs-parent="#columnsAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Required Columns (Must Include):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-danger border-3"><code>industry</code> - Corporate industry sector</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>annual_revenue</code> - Annual revenue in USD</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>num_employees</code> - Number of employees</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>current_ratio</code> - Current ratio</li>
                                                    <li class="list-group-item border-start border-danger border-3"><code>debt_to_equity</code> - Debt-to-equity ratio</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-success"><i class="fas fa-check-circle me-1"></i>Optional Columns (Auto-calculated if missing):</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item border-start border-success border-3"><code>free_cash_flow</code> - Free cash flow (estimated)</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>credit_rating</code> - External credit rating</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>times_interest_earned</code> - Interest coverage</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>roa</code> - Return on assets</li>
                                                    <li class="list-group-item border-start border-success border-3"><code>market_position</code> - Market position</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="alert alert-info mt-3 mb-0">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Note:</strong> Missing financial metrics will be estimated using industry benchmarks and revenue-based calculations.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions & Requirements -->
        <div class="row g-4 mt-3">
            <div class="col-md-6">
                <div class="card border-info h-100">
                    <div class="card-header bg-info-subtle border-info">
                        <h6 class="mb-0 text-info-emphasis">
                            <i class="fas fa-info-circle me-2"></i>File Format Requirements
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Format:</strong> CSV (Comma Separated Values) only
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Size:</strong> Maximum 10MB file size
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Records:</strong> Up to 10,000 records per file
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Encoding:</strong> UTF-8 encoding recommended
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Header:</strong> First row must contain column headers
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-success h-100">
                    <div class="card-header bg-success-subtle border-success">
                        <h6 class="mb-0 text-success-emphasis">
                            <i class="fas fa-rocket me-2"></i>Processing Features
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-lightning text-warning me-2"></i>
                                <strong>Auto-Fill:</strong> Missing columns filled with smart defaults
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-chart-line text-primary me-2"></i>
                                <strong>Progress:</strong> Real-time processing updates
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-shield-alt text-info me-2"></i>
                                <strong>Validation:</strong> Automatic data quality checks
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-download text-success me-2"></i>
                                <strong>Results:</strong> Downloadable JSON format
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-tags text-danger me-2"></i>
                                <strong>Output:</strong> Risk grades and IFRS 9 staging
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedFile = null;
let processingStartTime = null;
let processingInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeBatchForm();
    setupFileUpload();
    setupFormValidation();
});

function initializeBatchForm() {
    // Add segment selection handlers
    document.querySelectorAll('input[name="segment"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateSegmentSelection();
            validateForm();
        });
    });
    
    // Add keyboard support
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && processingInterval) {
            // Could add cancel processing functionality here
        }
    });
}

function setupFileUpload() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('batch-file');
    
    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.add('drag-over');
            uploadArea.style.borderColor = 'var(--bs-info)';
            uploadArea.style.backgroundColor = 'rgba(13, 202, 240, 0.1)';
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => {
            uploadArea.classList.remove('drag-over');
            uploadArea.style.borderColor = '';
            uploadArea.style.backgroundColor = '';
        }, false);
    });
    
    uploadArea.addEventListener('drop', handleFileDrop, false);
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleFileDrop(e) {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

function processFile(file) {
    if (!validateFileType(file)) return;
    if (!validateFileSize(file)) return;
    
    uploadedFile = file;
    
    // Update file info
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('file-status').textContent = 'Analyzing...';
    document.getElementById('file-status').className = 'badge bg-warning';
    
    // Show file preview container
    document.getElementById('file-preview-container').style.display = 'block';
    
    // Parse and preview file
    parseCSVFile(file);
    
    // Show processing options
    document.getElementById('processing-options').style.display = 'block';
    
    // Validate form
    validateForm();
    
    // Smooth scroll to preview
    setTimeout(() => {
        document.getElementById('file-preview-container').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100);
}

function validateFileType(file) {
    const allowedTypes = ['text/csv', 'application/csv'];
    const isCSV = allowedTypes.includes(file.type) || file.name.toLowerCase().endsWith('.csv');
    
    if (!isCSV) {
        showNotification('Please select a CSV file only.', 'warning');
        return false;
    }
    return true;
}

function validateFileSize(file) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    
    if (file.size > maxSize) {
        showNotification('File size must be less than 10MB. Please reduce your file size.', 'danger');
        return false;
    }
    return true;
}

function parseCSVFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n').filter(line => line.trim() !== '');
        
        if (lines.length < 2) {
            showValidationError('File must contain at least a header row and one data row.');
            return;
        }
        
        // Parse header
        const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
        
        // Parse first 5 data rows for preview
        const previewRows = [];
        for (let i = 1; i < Math.min(6, lines.length); i++) {
            const row = lines[i].split(',').map(cell => cell.trim().replace(/['"]/g, ''));
            previewRows.push(row);
        }
        
        // Update row count
        const rowCount = lines.length - 1;
        document.getElementById('file-rows').textContent = rowCount.toLocaleString();
        
        // Validate record count
        if (rowCount > 10000) {
            showValidationError(`Too many records (${rowCount.toLocaleString()}). Maximum allowed is 10,000 records.`);
            return;
        }
        
        // Create preview table
        createPreviewTable(headers, previewRows);
        
        // Validate data structure
        const isValid = validateDataStructure(headers, rowCount);
        
        // Update file status
        document.getElementById('file-status').textContent = isValid ? 'Valid' : 'Issues Found';
        document.getElementById('file-status').className = isValid ? 'badge bg-success' : 'badge bg-warning';
    };
    
    reader.onerror = function() {
        showValidationError('Error reading file. Please try again.');
    };
    
    reader.readAsText(file);
}

function createPreviewTable(headers, rows) {
    const table = document.getElementById('preview-table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    
    // Clear existing content
    thead.innerHTML = '';
    tbody.innerHTML = '';
    
    // Create header row
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        th.className = 'text-nowrap';
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    
    // Create data rows
    rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        row.forEach((cell, cellIndex) => {
            const td = document.createElement('td');
            td.textContent = cell.length > 20 ? cell.substring(0, 20) + '...' : cell;
            td.className = 'text-nowrap';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function validateDataStructure(headers, rowCount) {
    const validationResults = document.getElementById('validation-results');
    let validationHTML = '';
    let isValid = true;
    
    // Check row count
    if (rowCount > 10000) {
        validationHTML += `
            <div class="alert alert-danger border-0">
                <i class="fas fa-times-circle me-2"></i>
                <strong>Too many records:</strong> ${rowCount.toLocaleString()} rows. Maximum allowed is 10,000 rows.
            </div>
        `;
        isValid = false;
    } else if (rowCount > 5000) {
        validationHTML += `
            <div class="alert alert-warning border-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Large file detected:</strong> ${rowCount.toLocaleString()} rows. Processing may take longer.
            </div>
        `;
    } else {
        validationHTML += `
            <div class="alert alert-success border-0">
                <i class="fas fa-check-circle me-2"></i>
                <strong>File size optimal:</strong> ${rowCount.toLocaleString()} rows ready for processing.
            </div>
        `;
    }
    
    // Check required columns based on selected segment
    const selectedSegment = document.querySelector('input[name="segment"]:checked')?.value;
    if (selectedSegment) {
        const requiredColumns = getRequiredColumns(selectedSegment);
        const missingColumns = requiredColumns.filter(col => 
            !headers.some(header => header.toLowerCase().includes(col.toLowerCase()) || 
                         col.toLowerCase().includes(header.toLowerCase()))
        );
        
        if (missingColumns.length > 0) {
            validationHTML += `
                <div class="alert alert-warning border-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Missing columns will be auto-filled:</strong> ${missingColumns.join(', ')}
                    <br><small class="text-muted">The system will automatically provide default values for missing columns.</small>
                </div>
            `;
        } else {
            validationHTML += `
                <div class="alert alert-success border-0">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Column validation passed:</strong> All required columns found.
                </div>
            `;
        }
        
        // Show optional columns that are present
        const optionalColumns = getOptionalColumns(selectedSegment);
        const presentOptionalColumns = optionalColumns.filter(col => 
            headers.some(header => header.toLowerCase().includes(col.toLowerCase()) || 
                        col.toLowerCase().includes(header.toLowerCase()))
        );
        
        if (presentOptionalColumns.length > 0) {
            validationHTML += `
                <div class="alert alert-info border-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Optional columns detected:</strong> ${presentOptionalColumns.join(', ')}
                    <br><small class="text-muted">These will enhance prediction accuracy.</small>
                </div>
            `;
        }
    }
    
    validationResults.innerHTML = validationHTML;
    return isValid;
}

function getRequiredColumns(segment) {
    // Updated based on the actual requirements from the fixed app.py
    const requiredColumns = {
        retail: ['age', 'income', 'credit_score', 'debt_to_income', 'utilization_rate'],
        sme: ['industry', 'annual_revenue', 'num_employees', 'current_ratio', 'debt_to_equity'],
        corporate: ['industry', 'annual_revenue', 'num_employees', 'current_ratio', 'debt_to_equity']
    };
    
    return requiredColumns[segment] || [];
}

function getOptionalColumns(segment) {
    // Optional columns that will be auto-filled if missing
    const optionalColumns = {
        retail: ['employment_status', 'employment_tenure', 'years_at_address', 'num_accounts', 'monthly_transactions'],
        sme: ['profit_margin', 'years_in_business', 'payment_delays_12m', 'days_past_due', 'credit_utilization', 'interest_coverage'],
        corporate: ['credit_rating', 'times_interest_earned', 'roa', 'market_position', 'free_cash_flow', 'operating_cash_flow']
    };
    
    return optionalColumns[segment] || [];
}

function updateSegmentSelection() {
    const selectedSegment = document.querySelector('input[name="segment"]:checked')?.value;
    
    // Update UI based on selection
    document.querySelectorAll('.segment-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    if (selectedSegment) {
        const selectedOption = document.querySelector(`[data-segment="${selectedSegment}"]`);
        selectedOption.classList.add('selected');
        
        // Re-validate file if uploaded
        if (uploadedFile) {
            parseCSVFile(uploadedFile);
        }
    }
}

function validateForm() {
    const segment = document.querySelector('input[name="segment"]:checked');
    const file = uploadedFile;
    
    const submitBtn = document.getElementById('submitBtn');
    
    if (segment && file) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-outline-info');
        submitBtn.classList.add('btn-info');
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.remove('btn-info');
        submitBtn.classList.add('btn-outline-info');
    }
}

function setupFormValidation() {
    document.getElementById('batchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!uploadedFile) {
            showNotification('Please select a file to upload.', 'warning');
            return;
        }
        
        const selectedSegment = document.querySelector('input[name="segment"]:checked');
        if (!selectedSegment) {
            showNotification('Please select a model segment.', 'warning');
            return;
        }
        
        startBatchProcessing();
    });
}

function startBatchProcessing() {
    const formData = new FormData();
    formData.append('file', uploadedFile);
    formData.append('segment', document.querySelector('input[name="segment"]:checked').value);
    
    // Show progress section
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('progress-section').scrollIntoView({ behavior: 'smooth' });
    
    // Update submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    // Start processing timer
    processingStartTime = Date.now();
    processingInterval = setInterval(updateProcessingTime, 1000);
    
    // Initialize progress
    const totalRows = parseInt(document.getElementById('file-rows').textContent.replace(/,/g, ''));
    document.getElementById('total-records').textContent = totalRows.toLocaleString();
    
    // Update progress text
    document.getElementById('progress-text').innerHTML = `
        <i class="fas fa-cog fa-spin me-2"></i>Starting batch processing...
    `;
    
    // Actual API call
    fetch('/api/predict/batch', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        completeProcessing(data);
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Batch processing failed. Please try again.', 'danger');
        resetProcessing();
    });
}

function updateProgress(processed, failed, total) {
    const percentage = Math.min(((processed + failed) / total) * 100, 100);
    
    document.getElementById('batch-progress').style.width = percentage + '%';
    document.getElementById('progress-percentage').textContent = Math.round(percentage) + '%';
    document.getElementById('processed-records').textContent = processed.toLocaleString();
    document.getElementById('failed-records').textContent = failed.toLocaleString();
    
    if (percentage < 100) {
        document.getElementById('progress-text').innerHTML = `
            <i class="fas fa-cog fa-spin me-2"></i>Processing records... ${(processed + failed).toLocaleString()} of ${total.toLocaleString()} completed
        `;
    }
}

function updateProcessingTime() {
    if (processingStartTime) {
        const elapsed = Math.floor((Date.now() - processingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('processing-time').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function completeProcessing(data) {
    clearInterval(processingInterval);
    
    // Update final progress
    const total = data.total_predictions;
    const successful = data.successful_predictions;
    const failed = data.failed_predictions;
    
    updateProgress(successful, failed, total);
    
    // Update final status
    const successRate = (successful / total * 100).toFixed(1);
    document.getElementById('progress-text').innerHTML = `
        <i class="fas fa-check-circle text-success me-2"></i>
        <strong>Processing completed!</strong> ${successful.toLocaleString()} successful (${successRate}%), ${failed.toLocaleString()} failed.
        <br><small class="text-muted">Results are being prepared for download...</small>
    `;
    
    // Show summary if available
    if (data.summary_statistics && Object.keys(data.summary_statistics).length > 0) {
        setTimeout(() => {
            showSummaryStats(data.summary_statistics);
        }, 1000);
    }
    
    // Download results
    setTimeout(() => {
        downloadResults(data);
        showNotification(`Batch processing completed! ${successful.toLocaleString()} records processed successfully.`, 'success');
        
        // Reset form after delay
        setTimeout(() => {
            resetForm();
        }, 5000);
    }, 2000);
}

function showSummaryStats(stats) {
    const validationResults = document.getElementById('validation-results');
    
    let statsHTML = `
        <div class="alert alert-success border-0 mt-3">
            <h6><i class="fas fa-chart-bar me-2"></i>Processing Summary</h6>
    `;
    
    if (stats.avg_pd_score !== undefined) {
        statsHTML += `
            <div class="row">
                <div class="col-md-3">
                    <strong>Average PD:</strong> ${(stats.avg_pd_score * 100).toFixed(2)}%
                </div>
                <div class="col-md-3">
                    <strong>Median PD:</strong> ${(stats.median_pd_score * 100).toFixed(2)}%
                </div>
                <div class="col-md-3">
                    <strong>Min PD:</strong> ${(stats.min_pd_score * 100).toFixed(2)}%
                </div>
                <div class="col-md-3">
                    <strong>Max PD:</strong> ${(stats.max_pd_score * 100).toFixed(2)}%
                </div>
            </div>
        `;
    }
    
    if (stats.risk_grade_distribution) {
        statsHTML += `
            <div class="mt-2">
                <strong>Risk Grade Distribution:</strong>
        `;
        for (const [grade, count] of Object.entries(stats.risk_grade_distribution)) {
            statsHTML += ` ${grade}: ${count}`;
        }
        statsHTML += `</div>`;
    }
    
    statsHTML += `</div>`;
    
    validationResults.innerHTML += statsHTML;
}

function downloadResults(data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `batch_pd_results_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function resetProcessing() {
    clearInterval(processingInterval);
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Batch Processing';
    submitBtn.disabled = false;
    
    document.getElementById('progress-section').style.display = 'none';
    processingStartTime = null;
}

function removeFile() {
    uploadedFile = null;
    document.getElementById('batch-file').value = '';
    document.getElementById('file-preview-container').style.display = 'none';
    document.getElementById('processing-options').style.display = 'none';
    validateForm();
}

function resetForm() {
    removeFile();
    document.querySelectorAll('input[name="segment"]').forEach(radio => {
        radio.checked = false;
    });
    document.querySelectorAll('.segment-option').forEach(option => {
        option.classList.remove('selected');
    });
    resetProcessing();
    validateForm();
}

function formatFileSize(bytes) {
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 Bytes';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function showValidationError(message) {
    const validationResults = document.getElementById('validation-results');
    validationResults.innerHTML = `
        <div class="alert alert-danger border-0">
            <i class="fas fa-times-circle me-2"></i>
            <strong>Validation Error:</strong> ${message}
        </div>
    `;
    
    // Update file status
    document.getElementById('file-status').textContent = 'Invalid';
    document.getElementById('file-status').className = 'badge bg-danger';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible position-fixed fade show`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    `;
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function getNotificationIcon(type) {
    switch (type) {
        case 'success': return 'check-circle';
        case 'warning': return 'exclamation-triangle';
        case 'danger': return 'times-circle';
        case 'info':
        default: return 'info-circle';
    }
}

// Add CSS for enhanced styling
const style = document.createElement('style');
style.textContent = `
    .segment-option.selected .btn {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .upload-area {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: var(--bs-info) !important;
        background-color: rgba(13, 202, 240, 0.05) !important;
    }
    
    .upload-area.drag-over {
        transform: scale(1.02);
        border-color: var(--bs-success) !important;
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
    
    .btn-check:checked + .btn {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .alert {
        border-left: 4px solid;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .alert-success {
        border-left-color: var(--bs-success);
    }
    
    .alert-warning {
        border-left-color: var(--bs-warning);
    }
    
    .alert-danger {
        border-left-color: var(--bs-danger);
    }
    
    .alert-info {
        border-left-color: var(--bs-info);
    }
    
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .accordion-button {
        transition: all 0.2s ease;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: rgba(13, 202, 240, 0.1);
        color: var(--bs-info);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}